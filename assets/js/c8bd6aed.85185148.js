"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4026],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>f});var r=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var i=r.createContext({}),u=function(e){var n=r.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=u(e.components);return r.createElement(i.Provider,{value:n},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(t),m=o,f=p["".concat(i,".").concat(m)]||p[m]||d[m]||a;return t?r.createElement(f,l(l({ref:n},c),{},{components:t})):r.createElement(f,l({ref:n},c))}));function f(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,l=new Array(a);l[0]=m;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s[p]="string"==typeof e?e:o,l[1]=s;for(var u=2;u<a;u++)l[u]=t[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},8771:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>u});var r=t(7462),o=(t(7294),t(3905));const a={id:"koa2",slug:"/knowledgeStructure/node/koa2",title:"koa2 + vue\u5b9e\u73b0\u4e0a\u4f20\u56fe\u7247\u5230\u4e03\u725b\u4e91",date:new Date("2021-11-28T00:00:00.000Z"),tags:["node","koa2"]},l=void 0,s={unversionedId:"knowledgeStructure/node/koa2",id:"knowledgeStructure/node/koa2",title:"koa2 + vue\u5b9e\u73b0\u4e0a\u4f20\u56fe\u7247\u5230\u4e03\u725b\u4e91",description:"koa-multer",source:"@site/docs/knowledgeStructure/node/koa2.md",sourceDirName:"knowledgeStructure/node",slug:"/knowledgeStructure/node/koa2",permalink:"/blogs/docs/knowledgeStructure/node/koa2",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/knowledgeStructure/node/koa2.md",tags:[{label:"node",permalink:"/blogs/docs/tags/node"},{label:"koa2",permalink:"/blogs/docs/tags/koa-2"}],version:"current",frontMatter:{id:"koa2",slug:"/knowledgeStructure/node/koa2",title:"koa2 + vue\u5b9e\u73b0\u4e0a\u4f20\u56fe\u7247\u5230\u4e03\u725b\u4e91",date:"2021-11-28T00:00:00.000Z",tags:["node","koa2"]},sidebar:"tutorialSidebar",previous:{title:"obs+nodeMediaServer\u5b9e\u73b0\u5f55\u64ad\u3001\u76f4\u64ad",permalink:"/blogs/docs/knowledgeStructure/node/OBS"}},i={},u=[{value:"koa-multer",id:"koa-multer",level:2},{value:"\u670d\u52a1\u7aef",id:"\u670d\u52a1\u7aef",level:2},{value:"\u5728util\u6587\u4ef6\u5939\u4e2d\u65b0\u5efaupload.js",id:"\u5728util\u6587\u4ef6\u5939\u4e2d\u65b0\u5efauploadjs",level:2},{value:"vue\u4e2d\uff0c\u76f4\u63a5\u7528element ui \u63a7\u4ef6",id:"vue\u4e2d\u76f4\u63a5\u7528element-ui-\u63a7\u4ef6",level:2}],c={toc:u},p="wrapper";function d(e){let{components:n,...t}=e;return(0,o.kt)(p,(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"koa-multer"},"koa-multer"),(0,o.kt)("p",null,"\u9996\u5148\u5b89\u88c5\u63d2\u4ef6 koa-multer \u7528\u4e8e\u4e0a\u4f20\u56fe\u7247\u548cqiniu\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add  koa-multer\nyarn add  koa-qiniu  \n")),(0,o.kt)("h2",{id:"\u670d\u52a1\u7aef"},"\u670d\u52a1\u7aef"),(0,o.kt)("p",null,"\u65b0\u5efa\u6587\u4ef6qiniu.js"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'const multer = require("@koa/multer");\nconst Router = require("@koa/router");\nconst router = new Router();\nvar uuid = require(\'uuid\');\nconst  func  = require("../untils/upload");\n\n\nconst storage = multer.diskStorage({\n    // destination: function (req, file, cb) {\n    //   cb(null, path.join(__dirname, "../../public"));\n    // },\n    // filename: function (req, file, cb) {\n    //   let type = file.originalname.split(".")[1];\n    //   cb(null, `${file.fieldname}-${Date.now().toString(16)}.${type}`);\n    // },\n});\n\nconst limits = {\n    fields: 10, //\u975e\u6587\u4ef6\u5b57\u6bb5\u7684\u6570\u91cf\n    fileSize: 500 * 1024, //\u6587\u4ef6\u5927\u5c0f \u5355\u4f4d b\n    files: 1, //\u6587\u4ef6\u6570\u91cf\n};\n\nconst upload = multer({ storage, limits });\nvar fs = require(\'fs\');\nconst {formatResponse} = require("../untils/common");\nrouter.post(\'/upload\',upload.single("file"), async (ctx, next) => {\n    try {\n        const file = ctx.file; // \u83b7\u53d6\u4e0a\u4f20\u6587\u4ef6\n        // console.log(ctx.file)\n        if (file) {\n            const fileName = uuid.v1();\n            // \u521b\u5efa\u6587\u4ef6\u53ef\u8bfb\u6d41\n            const reader = fs.createReadStream(file.path);\n            // \u83b7\u53d6\u4e0a\u4f20\u6587\u4ef6\u6269\u5c55\u540d\n            const ext = file.originalname.split(".").pop();\n            // \u547d\u540d\u6587\u4ef6\u4ee5\u53ca\u62d3\u5c55\u540d\n            const fileUrl = `public/${fileName}.${ext}`;\n\n            const result = await func.upToQiniu(reader, fileUrl);\n\n            console.log(result)\n\n            if (result) {\n                ctx.body = formatResponse("200", result, "success");\n            } else {\n                ctx.body = formatResponse("500", \'\u4e0a\u4f20\u5931\u8d25\', "success");\n            }\n        } else {\n            ctx.body = formatResponse("500", \'\u6ca1\u6709\u9009\u62e9\u56fe\u7247\', "success");\n        }\n    } catch (err) {\n        ctx.body = formatResponse("500", \'err\', "success");\n    }\n})\nmodule.exports = router\n')),(0,o.kt)("h2",{id:"\u5728util\u6587\u4ef6\u5939\u4e2d\u65b0\u5efauploadjs"},"\u5728util\u6587\u4ef6\u5939\u4e2d\u65b0\u5efaupload.js"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"let uuid = require('uuid');\nlet fs = require('fs');\n// \u4e0a\u4f20\u5230\u4e03\u725b\nlet qiniu = require('qiniu'); // \u9700\u8981\u52a0\u8f7dqiniu\u6a21\u5757\u7684\n// \u5f15\u5165key\u6587\u4ef6\nconst QINIU = {\n    accessKey: '\u8f93\u5165Accesskey',  // \u5728\u4e03\u725b\u4e91\u5b98\u7f51\u7533\u8bf7\n    secretKey: '\u8f93\u5165secretKey',\n    bucket: 'my-workspace-image'  // bucket\u662f\u5b58\u50a8\u7a7a\u95f4\u540d\u79f0\n}\nconst upToQiniu = (filePath, key) => {\n    const accessKey = QINIU.accessKey\n    const secretKey = QINIU.secretKey\n    const mac = new qiniu.auth.digest.Mac(accessKey, secretKey)\n  \n    const options = {\n        scope: QINIU.bucket\n    }\n    const putPolicy = new qiniu.rs.PutPolicy(options);\n\n    const uploadToken = putPolicy.uploadToken(mac);\n    // zone \u534e\u4e1c\u673a\u623f  zone1 \u534e\u5317\u673a\u623f  zone2 \u534e\u5357\u673a\u623f   zoneNa0 \u5317\u7f8e\n    const config = new qiniu.conf.Config()\n    config.zone = qiniu.zone.zone2\n    \n    const localFile = filePath\n    const formUploader = new qiniu.form_up.FormUploader(config)\n    const putExtra = new qiniu.form_up.PutExtra()\n    // \u6587\u4ef6\u4e0a\u4f20\n    return new Promise((resolved, reject) => {\n        formUploader.putStream(uploadToken, key, localFile, putExtra, function (respErr, respBody, respInfo) {\n            if (respErr) {\n                reject(respErr)\n            } else {\n                resolved(respBody)\n            }\n        })\n    })\n}\nmodule.exports = {\n    upToQiniu,\n}\n\n")),(0,o.kt)("p",null,"\u5728\u4e0a\u4f20\u56fe\u7247\u5230\u4e03\u725b\u4e91\u65f6\uff0c\u60f3\u5230\u4e0d\u80fd\u76f4\u63a5\u653e\u5728\u81ea\u5df1\u7684\u5b58\u50a8\u7a7a\u95f4\u4e0b\u9762\uff0c\u6240\u4ee5\u53ef\u4ee5\u5728\u6bcf\u5f20\u4e0a\u4f20\u7684\u56fe\u7247\u8def\u5f84\u4e0a\u52a0\u4e0a /public"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"   const fileUrl = `public/${fileName}.${ext}`;\n")),(0,o.kt)("p",null,"\u8fd9\u6837\u4e0a\u4f20\u7684\u56fe\u7247\u4f1a\u662f my-workspace-image/public \u91cc\u9762\u3002"),(0,o.kt)("h2",{id:"vue\u4e2d\u76f4\u63a5\u7528element-ui-\u63a7\u4ef6"},"vue\u4e2d\uff0c\u76f4\u63a5\u7528element ui \u63a7\u4ef6"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'       <el-upload\n          class="avatar-uploader"\n          name="file"\n          :action="\'localhost:8081/qiniu/upload\'"\n          :show-file-list="false"\n          :on-success="handleAvatarSuccess"\n          :before-upload="beforeAvatarUpload"\n          :on-error="uploadFiled"\n            >\n          <img v-if="imageUrl" :src="imageUrl | img" class="avatar">\n          <i v-else class="el-icon-plus avatar-uploader-icon"></i>\n         </el-upload>\n')),(0,o.kt)("p",null,"js"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"    const   handleAvatarSuccess=(res, file)=>{\n            // debugger\n            if(res.code==='200'){\n                this.ruleForm.courseTypeLogo = res.data.key;\n                this.imageUrl = res.data.key;\n                this.$message({\n                    message: '\u4e0a\u4f20\u6210\u529f',\n                    type: 'success'\n                });\n            }else {\n                // this.$message.error('\u4e0a\u4f20\u5931\u8d25');\n            }\n        }\n    const  uploadFiled=(err)=>{\n            this.$message.error('\u4e0a\u4f20\u5931\u8d25');\n          console.log(err)\n        }\n     const  beforeAvatarUpload=(file)=>{\n            const isJPG = file.type === 'jpg' || 'png';\n            const isLt2M = file.size / 1024 / 1024 < 2;\n\n            if (!isJPG) {\n                this.$message.error('\u4e0a\u4f20\u5934\u50cf\u56fe\u7247\u53ea\u80fd\u662f JPG\u548cpng \u683c\u5f0f!');\n            }\n            if (!isLt2M) {\n                this.$message.error('\u4e0a\u4f20\u5934\u50cf\u56fe\u7247\u5927\u5c0f\u4e0d\u80fd\u8d85\u8fc7 2MB!');\n            }\n            return isJPG && isLt2M;\n        }\n")))}d.isMDXComponent=!0}}]);